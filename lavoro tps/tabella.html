<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Anagrafica 5E</title>
  <link rel="stylesheet" href="tabella.css">
</head>

<body>

  <h1>Anagrafica Classe 5E</h1>

  <div>
    <label for="letterFilter">Filtra cognomi per iniziale:</label>
    <input type="text" id="letterFilter" maxlength="1" size="1" placeholder="A" />
    <button id="btnFiltra">Filtra</button>
    <button id="btnMostraTutti">Mostra tutti</button>
  </div>

  <div>
    <button id="btnMaggiorenni">Mostra solo maggiorenni</button>
  </div>

  <h2>Tabella Utenti</h2>
  <div id="tabellaContainer">Caricamento dati...</div>

  <script>
    let utenti = [];

    function caricaDati() {
      const req = new XMLHttpRequest();
      req.open("GET", 'nomi.json', true);
      req.send();
      req.onload = function() {
        if (req.status >= 200 && req.status < 300) {
          try {
            utenti = JSON.parse(req.responseText);
            document.getElementById('tabellaContainer').innerHTML = '<pUsa i pulsanti per mostrare la tabella.</p>';
          } catch (e) {
            document.getElementById('tabellaContainer').innerHTML = "Errore nel parsing dei dati JSON";
            console.error(e);
          }
        } else {
          document.getElementById('tabellaContainer').innerHTML = "Errore nel caricamento del file JSON";
          console.error('HTTP error', req.status);
        }
      };
      req.onerror = function() {
        document.getElementById('tabellaContainer').innerHTML = "Errore nella richiesta HTTP";
      };
    }

    function mostraTabella(lista) {
      if (!lista.length) {
        document.getElementById('tabellaContainer').innerHTML = '<p>Nessun dato da mostrare.</p>';
        return;
      }
      let html = '<table><tr><th>Nome</th><th>Cognome</th><th>Data di Nascita</th><th>Et√†</th></tr>';
      lista.forEach(u => {
        const eta = calcolaEta(u.dataNascita);
        html += `<tr>
          <td>${u.nome}</td>
          <td>${u.cognome}</td>
          <td>${u.dataNascita}</td>
          <td>${eta}</td>
        </tr>`;
      });
      html += '</table>';
      document.getElementById('tabellaContainer').innerHTML = html;
    }

    function calcolaEta(dataNascita) {
      const oggi = new Date();
      const nascita = new Date(dataNascita);
      let eta = oggi.getFullYear() - nascita.getFullYear();
      const mese = oggi.getMonth() - nascita.getMonth();
      if (mese < 0 || (mese === 0 && oggi.getDate() < nascita.getDate())) {
        eta--;
      }
      return eta;
    }

    function filtraPerLettera() {
      const lettera = document.getElementById('letterFilter').value.trim().toUpperCase();
      if (!lettera.match(/^[A-Z]$/)) {
        alert('Inserisci una singola lettera (A-Z)');
        return;
      }
      const filtrati = utenti.filter(u => u.cognome.toUpperCase().startsWith(lettera));
      mostraTabella(filtrati);
    }

    function mostraMaggiorenni() {
      const maggiorenni = utenti.filter(u => calcolaEta(u.dataNascita) >= 18);
      mostraTabella(maggiorenni);
    }

    function mostraTutti() {
      mostraTabella(utenti);
    }

    window.onload = () => {
      caricaDati();
      document.getElementById('btnFiltra').onclick = filtraPerLettera;
      document.getElementById('btnMaggiorenni').onclick = mostraMaggiorenni;
      document.getElementById('btnMostraTutti').onclick = mostraTutti;
    };
  </script>

</body>
</html>
